---
- hosts: raspberries
  gather_facts: no
  become: yes

  pre_tasks:
    - name: Wait till RPI enters the running phase
      wait_for_connection:

  tasks:
    - name: Update the RPI
      apt:
        update_cache: yes

    - name: Copy the files to the RPI
      copy:
        src: /picarfiles/
        dest: /home/pi/
        follow: yes

    - name: install nodejs dependencies
      apt:
        name: nodejs
        state: present

    - name: install npm
      apt:
        name: npm
        state: present

    - name: install python3
      apt:
        name: python3
        state: present

    - name: install python3-pip
      apt:
        name: python3-pip
        state: present

    - name: Run the socket servers package.json
      npm:
        path: /home/pi/server

    - name: Install the dependencies for the driver
      pip:
        requirements: /home/pi/driver/requirements.txt
        executable: pip3

    - name: lookup script files with .sh extension
      find:
        paths: /home/pi/scripts/
        file_type: file
        patterns: "*.sh"
      register: filelist

    - name: change permissions on the script files
      file:
        path: "{{ item.path }}"
        state: file
        mode: "0775"
      with_items: "{{ filelist.files }}"

    - name: Move the services files to the correct location
      copy:
        src: /home/pi/services/
        dest: /etc/systemd/system/
        remote_src: yes

    - name: Enable the driver service
      systemd:
        name: driver
        enabled: yes
        state: started

    - name: Enable the socket server service
      systemd:
        name: socket
        enabled: yes
        state: started

    - name: reload the systemctl daemon to enable the services
      systemd:
        daemon_reload: yes

    - name: Enable I2C on the Raspberry Pi
      shell: "raspi-config nonint do_i2c 0"

    - name: Remove the swap partition
      shell: "swapoff -a"

    - name: Shutdown the RPI
      shell: shutdown -h now
      ignore_unreachable: true

    - name: Install qemu on local machine
      local_action:
        module: apk
        name: qemu-img
        update_cache: yes

    - name: Use qemu-img to create a disk image retry until the pi fully shuts down
      local_action:
        module: shell
        cmd: qemu-img convert -f qcow2 -O raw /picarimage/distro.qcow2 /picarimage/PiCarV.img
      register: result

      retries: 300
      delay: 1
      until: result.rc == 0
#    - name: Install PiShrink Dependencies parted
#      local_action:
#        module: apk
#        name: parted
#
#    - name: Install PiShrink Dependencies tune2fs
#      local_action:
#        module: apk
#        name: e2fsprogs-extra
###############################################################################################
#### This block doesn't work right now because pishrink doesn't work with swap partitions #####
###############################################################################################
# - name: Install PiShrink
#   local_action:
#     module: get_url
#     url: https://raw.githubusercontent.com/Drewsif/PiShrink/master/pishrink.sh
#     dest: /usr/local/bin
#
# - name: Make the PiShrink script executable
#   local_action:
#     module: file
#     path: /usr/local/bin/pishrink.sh
#     state: file
#     mode: "0775"
#
# - name: Change the permissions of the image file
#   local_action:
#     module: file
#     path: /picarimage/PiCarV.img
#     state: file
#     mode: "0777"
#
# - name: Run PiShrink
#   local_action:
#     module: shell
#     cmd: "pishrink.sh /picarimage/PiCarV.img"
